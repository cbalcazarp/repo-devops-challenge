node {
  def commit_id
  stage('Preparation') {
    checkout scm
    sh "git rev-parse --short HEAD > .git/commit-id"                        
    commit_id = readFile('.git/commit-id').trim()
  }
  stage('Installation & Test') {
    sh 'npm install --only=dev'
    sh 'npm test'
  }
  stage('Build & Push image') {
    withDockerRegistry([ credentialsId: "dockerhub", url: "" ]) {
      sh "docker build -t cbalcazarp/repo-devops-challenge:${commit_id} ."
      sh "docker push cbalcazarp/repo-devops-challenge:${commit_id}"
    }
    echo ${commit_id}
  }
  /* stage('Deploy to Server') {
    sshagent([ 'VM-alpha' ]) {
      sh 'ls -lh /var/lib/jenkins/workspace/My-first-pipeline@tmp/*.key'
      sh 'ssh -o StrictHostKeyChecking=no ubuntu@54.172.103.101'
      sh 'ls'
    }
  } */
}